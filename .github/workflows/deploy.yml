name: ğŸš€ Hi-Care AI ì±—ë´‡ ë°°í¬

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'ë°°í¬ í™˜ê²½'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ğŸ—ï¸ ë¹Œë“œ ë° í‘¸ì‹œ
  build-and-push:
    name: ğŸ—ï¸ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      contents: read
      packages: write
      
    outputs:
      backend-image: ${{ steps.meta-backend.outputs.tags }}
      frontend-image: ${{ steps.meta-frontend.outputs.tags }}
      
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ğŸ³ Docker Buildx ì„¤ì •
        uses: docker/setup-buildx-action@v3
        
      - name: ğŸ” Container Registry ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ“Š ë°±ì—”ë“œ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            
      - name: ğŸ“Š í”„ë¡ íŠ¸ì—”ë“œ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            
      - name: ğŸ—ï¸ ë°±ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: backend
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          
      - name: ğŸ—ï¸ í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        uses: docker/build-push-action@v5
        with:
          context: frontend
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ğŸ¯ ìŠ¤í…Œì´ì§• ë°°í¬
  deploy-staging:
    name: ğŸ­ ìŠ¤í…Œì´ì§• ë°°í¬
    runs-on: ubuntu-latest
    needs: [build-and-push]
    environment: staging
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'staging'
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ğŸ­ ìŠ¤í…Œì´ì§• í™˜ê²½ ë°°í¬
        run: |
          echo "ğŸ­ ìŠ¤í…Œì´ì§• í™˜ê²½ì— ë°°í¬ ì¤‘..."
          echo "Backend Image: ${{ needs.build-and-push.outputs.backend-image }}"
          echo "Frontend Image: ${{ needs.build-and-push.outputs.frontend-image }}"
          # ì‹¤ì œ ë°°í¬ ëª…ë ¹ì–´ ì¶”ê°€ (ì˜ˆ: kubectl, helm, docker-compose ë“±)
          
      - name: ğŸ¥ í—¬ìŠ¤ì²´í¬
        run: |
          echo "ğŸ¥ ìŠ¤í…Œì´ì§• í™˜ê²½ í—¬ìŠ¤ì²´í¬ ì‹¤í–‰ ì¤‘..."
          # ì‹¤ì œ í—¬ìŠ¤ì²´í¬ ëª…ë ¹ì–´ ì¶”ê°€
          
      - name: ğŸ§ª ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ§ª ìŠ¤í…Œì´ì§• í™˜ê²½ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
          # ì‹¤ì œ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ ëª…ë ¹ì–´ ì¶”ê°€

  # ğŸš€ í”„ë¡œë•ì…˜ ë°°í¬
  deploy-production:
    name: ğŸš€ í”„ë¡œë•ì…˜ ë°°í¬
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-staging]
    environment: production
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.environment == 'production'
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        
      - name: ğŸš€ í”„ë¡œë•ì…˜ í™˜ê²½ ë°°í¬
        run: |
          echo "ğŸš€ í”„ë¡œë•ì…˜ í™˜ê²½ì— ë°°í¬ ì¤‘..."
          echo "Backend Image: ${{ needs.build-and-push.outputs.backend-image }}"
          echo "Frontend Image: ${{ needs.build-and-push.outputs.frontend-image }}"
          # ì‹¤ì œ ë°°í¬ ëª…ë ¹ì–´ ì¶”ê°€
          
      - name: ğŸ¥ í”„ë¡œë•ì…˜ í—¬ìŠ¤ì²´í¬
        run: |
          echo "ğŸ¥ í”„ë¡œë•ì…˜ í™˜ê²½ í—¬ìŠ¤ì²´í¬ ì‹¤í–‰ ì¤‘..."
          # ì‹¤ì œ í—¬ìŠ¤ì²´í¬ ëª…ë ¹ì–´ ì¶”ê°€
          
      - name: ğŸ“¢ ë°°í¬ ì•Œë¦¼
        run: |
          echo "ğŸ“¢ í”„ë¡œë•ì…˜ ë°°í¬ ì™„ë£Œ ì•Œë¦¼ ì „ì†¡ ì¤‘..."
          # ì‹¤ì œ ì•Œë¦¼ ëª…ë ¹ì–´ ì¶”ê°€ (Slack, Teams, ì´ë©”ì¼ ë“±)

  # ğŸ”„ ë¡¤ë°±
  rollback:
    name: ğŸ”„ ë¡¤ë°±
    runs-on: ubuntu-latest
    if: failure() && (startsWith(github.ref, 'refs/tags/v') || github.event.inputs.environment == 'production')
    needs: [deploy-production]
    environment: production
    
    steps:
      - name: ğŸ”„ ìë™ ë¡¤ë°± ì‹¤í–‰
        run: |
          echo "ğŸ”„ í”„ë¡œë•ì…˜ í™˜ê²½ ìë™ ë¡¤ë°± ì‹¤í–‰ ì¤‘..."
          # ì‹¤ì œ ë¡¤ë°± ëª…ë ¹ì–´ ì¶”ê°€
          
      - name: ğŸš¨ ë¡¤ë°± ì•Œë¦¼
        run: |
          echo "ğŸš¨ í”„ë¡œë•ì…˜ ë¡¤ë°± ì•Œë¦¼ ì „ì†¡ ì¤‘..."
          # ì‹¤ì œ ì•Œë¦¼ ëª…ë ¹ì–´ ì¶”ê°€ 